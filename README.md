# ERL for FJSP
Modification of the IEEE TII paper [Flexible Job Shop Scheduling via Graph Neural Network and Deep Reinforcement Learning](https://ieeexplore.ieee.org/document/9826438). *IEEE Transactions on Industrial Informatics*, 2022 to investigate ERL for FJSP.

```
@ARTICLE{9826438,  
   author={Song, Wen and Chen, Xinyang and Li, Qiqiang and Cao, Zhiguang},  
   journal={IEEE Transactions on Industrial Informatics},   
   title={Flexible Job Shop Scheduling via Graph Neural Network and Deep Reinforcement Learning},   
   year={2022},  
   volume={},  
   number={},  
   pages={1-11},  
   doi={10.1109/TII.2022.3189725}
 }
```

## Get Started

### Installation

* python $\ge$ 3.6.13
* pytorch $\ge$ 1.8.1
* gym $\ge$ 0.18.0 & $\le$ 0.20.0
* numpy $\ge$ 1.19.5
* pandas $\ge$ 1.1.5
* visdom $\ge$ 0.1.8.9

Note that pynvml is used in ```test.py``` to avoid excessive memory usage of GPU, please modify the code when using CPU.

### Introduction

* ```data``` saves the instance files generated by ```./utils/create_ins.py```
* ```data/dev``` and ```data/test``` are the validation sets and test sets, respectively.

* ```Results``` saves the trained models and records test results
* ```Code/env``` contains code for the DRL environment
* ```Code/graph``` is part of the code related to the graph neural network
* ```Code/utils``` contains some helper functions
* ```Code/configs``` contains the configuration files
* ```Code/mlp.py``` is the MLP code (referenced from L2D)
* ```Code/PPO_model.py``` contains the implementation of the algorithms in this article, including HGNN and PPO algorithms
* ```Code/ERL_model.py``` modification for PPO_model.py to accomodate the ERL models
* ```Code/neuroevolution.py``` contains the functions for performing basic NE given a population of actors
* ```Code/test.py``` for testing
* ```Code/train.py``` for training
* ```Code/validate.py``` is used for validation without manual calls

* ```Main/Array.sh``` for submitting an array jobs on the ECS grid
* ```Main/Job_TR.sh``` job file for doing training
* ```Main/Job_NE.sh``` job file for doing testing on ERL_0 models
* ```Main/Job_NN.sh``` job file for doing testing on ERL_2.0 & 2.1 models

## Reproduce results for ERL models

There are various experiments in this article, which are difficult to be covered in a single run. Therefore, please change ```config.json``` before running.

Note that disabling the ```validate_gantt()``` function in ```schedule()``` can improve the efficiency of the program, which is used to check whether the solution is feasible.

### train

```
python train.py seed method size=(1005, 2005, 1510, 2010) algo
```

Note that there should be a validation set of the corresponding size in ```data/dev```.

### test

```
python test.py seed method size=(1005, 2005, 1510, 2010) algo nn=(Y,N)
```
Note that there should be model files (```*.pt```) in ```Results/method/size/model/algo```.

## Reference

* https://github.com/songwenas12/fjsp-drl
* https://github.com/zcaicaros/L2D
* https://github.com/yd-kwon/MatNet
* https://github.com/dmlc/dgl/tree/master/examples/pytorch/han

---

# Additional Instruction
* The output files are now in .csv format instead of .xls
* Test folder name now contain "-G" or "-S" to indicate used strategy (Greedy or Sampling)
* Train & test file now contain the enviroment setup (e.g 10 jobs & 5 machines -> "file_10_5")


## Config file
* For a given size,
* Update the env_paras and/or train_paras or training
* Update the test_paras for testing (specify the strategy here: sample = true is Sampling |
                                                                sample = false  is Greedy)


## Results
* Each subfolder of the specifed method contains the trained model and the corresponding experimental results
* Test output files of a specified algorithm contain the makespan of each instances in the test files
* Train output files of a specified algorithm contain the validation makespan overtime during training
* All runs were done on the lab computer CPU (Intel i7-8700 12 cores @ 3.2GHz)


## Running
* Ensure the installation specification is met (specifically 'gym')
* Modify the config file if needed
* Navigate to the Code folder 
* Run python train.py or test.py with the required arguments (seed, method, size, algo, nn (for test.py))
